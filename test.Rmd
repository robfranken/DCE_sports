---
title: "Analyses"
bibliography: references.bib
date: "Last compiled on `r format(Sys.time(), '%B, %Y')`"
output: 
  html_document:
    css: tweaks.css
    toc:  true
    toc_float: true
    number_sections: true
    toc_depth: 2
    code_folding: show
    code_download: yes
---

```{r, globalsettings, echo=FALSE, warning=FALSE, results='hide', message=FALSE}
library(knitr)
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
opts_chunk$set(tidy.opts=list(width.cutoff=100),tidy=TRUE, warning = FALSE, message = FALSE,comment = "#>", cache=TRUE, class.source=c("test"), class.output=c("test3"))
options(width = 100)
rgl::setupKnitr()

colorize <- function(x, color) {sprintf("<span style='color: %s;'>%s</span>", color, x) }
```


```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = c('top', 'right'))
#klippy::klippy(color = 'darkred')
#klippy::klippy(tooltip_message = 'Click to copy', tooltip_success = 'Done')
```


---  


To copy the code, click the button in the upper right corner of the code-chunks.

# Getting started

## clean up

```{r, results='hide'}
rm(list=ls())
gc()
```

<br>

## general custom functions

- `fpackage.check`: Check if packages are installed (and install if not) in R
- `fsave`: Function to save data with time stamp in /correct directory
- `fload`: Function to load R-objects under new names
- `ftable`

```{r}
fpackage.check <- function(packages) {
    lapply(packages, FUN = function(x) {
        if (!require(x, character.only = TRUE)) {
            install.packages(x, dependencies = TRUE)
            library(x, character.only = TRUE)
        }
    })
}

fsave <- function(x, file, location = "./data/processed/", ...) {
    if (!dir.exists(location))
        dir.create(location)
    datename <- substr(gsub("[:-]", "", Sys.time()), 1, 8)
    totalname <- paste(location, datename, file, sep = "")
    print(paste("SAVED: ", totalname, sep = ""))
    save(x, file = totalname)
}


fload  <- function(fileName){
  load(fileName)
  get(ls()[ls() != "fileName"])
}


ftable <- function(x, caption=NULL) {
  knitr::kable(x, digits=2, "html", caption=caption) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) %>%
    kableExtra::scroll_box(height="300px")
}
```

<br>

## necessary packages

- `tidyverse`: data wrangling
- `cregg`

```{r, eval=FALSE}
packages = c("tidyverse", "cregg")
fpackage.check(packages)
```

<br>

# import

Load in data-set, created [here](link).

You may also obtain it by downloading: `xfun::embedd`

```{r}
today <- gsub("-", "", Sys.Date())
data <- fload(paste0("./data/processed/", today, "conjoint.Rda"))
```

<br>

# Marginal means

The descriptive marginal means (MMs) illustrate the average outcome for a specific level of a conjoint feature, taking into account all occurrences and averaging across other features. In our study, participants were presented with three alternatives in each choice set, resulting in MMs that average at 0.33. Values above 0.33 indicate features that enhance the attractiveness of alternatives, while values below 0.33 indicate features that reduce the attractiveness of alternatives.

```{r, fig.width=10, warning=FALSE, message=FALSE} 
f1 <- choice ~ comparison + knowledge + companionship + encouragement
plot(cregg::mm(data, f1, id=~id), vline=1/3)
```

<br>


# Average marginal component effect

Average marginal component effects (AMCEs).

```{r, fig.width=10, warning=FALSE, message=FALSE} 
amces <- cregg::cj(data, f1, id = ~id)
ftable(amces[c("feature", "level", "estimate", "std.error")])
plot(amces)
```



<style>
.scrollbox {
  max-height: 400px; /* Specify the maximum height of the scrollbox */
  overflow-y: scroll; /* Enable vertical scrolling */
  border: 1px solid #ccc; /* Add a border for visual distinction */
}
</style>

## reference category diagnostics for AMCEs


<div class="scrollbox">

```{r, fig.width=12, fig.height=12, warning=FALSE, message=FALSE, class.source='fold-hide'} 
amce_diagnostic1 <- cregg::amce_by_reference(data, choice ~ comparison, ~comparison, id = ~id)
amce_diagnostic2 <- cregg::amce_by_reference(data, choice ~ knowledge, ~knowledge, id = ~id)
amce_diagnostic3 <- cregg::amce_by_reference(data, choice ~ companionship, ~companionship, id = ~id)
amce_diagnostic4 <- cregg::amce_by_reference(data, choice ~ encouragement, ~encouragement, id = ~id)

plot1 <- plot(amce_diagnostic1, group = "REFERENCE", legend_title = "Ref. cat.")
plot2 <- plot(amce_diagnostic2, group = "REFERENCE", legend_title = "Ref. cat.")
plot3 <- plot(amce_diagnostic3, group = "REFERENCE", legend_title = "Ref. cat.")
plot4 <- plot(amce_diagnostic4, group = "REFERENCE", legend_title = "Ref. cat.")

multiplot <- gridExtra::grid.arrange(plot1,plot2,plot3,plot4,ncol=1)
```
</div>

<br>

# Subgroup analysis

## Subgroup marginal means

Let's ensure that there are no substantial variations in preferences within-respondents across multiple conjoint choice-tasks:

```{r, fig.width=10, warning=FALSE, message=FALSE} 
mm_byset <- cregg::cj(data, f1, id = ~id, estimate = "mm", by = ~set)
plot(mm_byset, group = "set", vline = 1/3)
```

<br>

## Test of preference heterogeneity 

A nested model comparison test:

```{r}
cregg::cj_anova(data, f1, by = ~set)
```

<br>

## Differences for male vs. female

### MMs

```{r, fig.width=10, warning=FALSE, message=FALSE} 
data$Sex <- NA_real_
data$Sex[data$gender == "man"] <- 1L
data$Sex[data$gender == "woman"] <- 2L

data$Sex <- factor(data$Sex, 1:2, c("Male", "Female"))

x <- cregg::cj(na.omit(data), f1, id = ~id, estimate = "mm", by = ~Sex)
plot(x, group = "Sex", vline=1/3)
```

### Conditional AMCEs

```{r, fig.width=10, warning=FALSE, message=FALSE} 
amces <- cregg::cj(na.omit(data), f1, id = ~id, estimate = "amce", by = ~Sex)
diff_amces <- cregg::cj(na.omit(data), f1, id = ~id, estimate = "amce_diff", by = ~Sex)
ftable(amces)
ftable(diff_amces)
plot(rbind(amces, diff_amces)) + ggplot2::facet_wrap(~BY, ncol = 3L)
```

<br>

## Differences for active vs. non-active

### MMs

```{r, fig.width=10, warning=FALSE, message=FALSE} 
data$Active <- NA_real_

data$Active[data$activeW2 == "yes"] <- 2L
data$Active[data$activeW2 == "no"] <- 1L

data$Active <- factor(data$Active, 1:2, c("No", "Yes"))

x <- cregg::cj(data, f1, id = ~id, estimate = "mm", by = ~Active)
plot(x, group = "Active", vline=1/3)
```

### Conditional AMCEs

```{r, fig.width=10, warning=FALSE, message=FALSE} 
amces <- cregg::cj(data, f1, id = ~id, estimate = "amce", by = ~Active)

diff_amces <- cregg::cj(data, f1, id = ~id, estimate = "amce_diff", by = ~Active)
ftable(amces)
ftable(diff_amces)
plot(rbind(amces, diff_amces)) + ggplot2::facet_wrap(~BY, ncol = 3L)
```

<br>

## Differences across activity levels

### MMs

```{r, fig.width=10, warning=FALSE, message=FALSE} 
data$Frequency <- NA_real_

hist(as.numeric(data$sportsfreq,na.rm=TRUE))
ftable(psych::describe(data$sportsfreq,na.rm=TRUE), caption= "Running frequency statistics")

data$Frequency[data$sportsfreq < 3] <- 1L
data$Frequency[data$sportsfreq >= 3] <- 2L

data$Frequency <- factor(data$Frequency, 1:2, c("Low frequency", "High frequency"))

x <- cregg::cj(na.omit(data), f1, id = ~id, estimate = "mm", by = ~Frequency)
plot(x, group = "Frequency", vline=1/3)
```

### Conditional AMCEs

```{r, fig.width=10, warning=FALSE, message=FALSE} 
amces <- cregg::cj(na.omit(data), f1, id = ~id, estimate = "amce", by = ~Frequency)

diff_amces <- cregg::cj(na.omit(data), f1, id = ~id, estimate = "amce_diff", by = ~Frequency)
ftable(amces)
ftable(diff_amces)
plot(rbind(amces, diff_amces)) + ggplot2::facet_wrap(~BY, ncol = 3L)
```

<br>

# Interactions
<div class="scrollbox">

```{r, fig.width=12, fig.height=12, warning=FALSE, message=FALSE, class.source='fold-hide'} 

data$comparison_sex <- interaction(data$comparison, data$Sex, sep = "_")
data$knowledge_sex <- interaction(data$knowledge, data$Sex, sep = "_")
data$companionship_sex <- interaction(data$companionship, data$Sex, sep = "_")
data$encouragement_sex <- interaction(data$encouragement, data$Sex, sep = "_")
#average component interaction effect
acies1 <- cregg::amce(data, choice ~ comparison_sex, id = ~id)
acies2 <- cregg::amce(data, choice ~ knowledge_sex, id = ~id)
acies3 <- cregg::amce(data, choice ~ companionship_sex, id = ~id)
acies4 <- cregg::amce(data, choice ~ encouragement_sex, id = ~id)

plot1 <- plot(acies1)
plot2 <- plot(acies2)
plot3 <- plot(acies3)
plot4 <- plot(acies4)

multiplot <- gridExtra::grid.arrange(plot1,plot2,plot3,plot4,ncol=1)
```

</div>

<br>

# Diagnostics

## Frequencies

Of conjoint features (to ensure equal display frequency):

```{r, fig.width=12, fig.height=12, warning=FALSE, message=FALSE}
plot(cregg::cj_freqs(data, choice ~ comparison + knowledge + companionship + encouragement + Sex + Active + Frequency, id = ~id))
```

---