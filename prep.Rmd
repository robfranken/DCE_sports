---
title: "Data preparation"
bibliography: references.bib
date: "Last compiled on `r format(Sys.time(), '%B, %Y')`"
output: 
  html_document:
    css: tweaks.css
    toc:  true
    toc_float: true
    number_sections: true
    toc_depth: 1
    code_folding: show
    code_download: yes
---

```{r, globalsettings, echo=FALSE, warning=FALSE, results='hide'}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
opts_chunk$set(tidy.opts=list(width.cutoff=100),tidy=TRUE, warning = FALSE, message = FALSE,comment = "#>", cache=TRUE, class.source=c("test"), class.output=c("test3"))
options(width = 100)
rgl::setupKnitr()

colorize <- function(x, color) {sprintf("<span style='color: %s;'>%s</span>", color, x) }
```


```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = c('top', 'right'))
#klippy::klippy(color = 'darkred')
#klippy::klippy(tooltip_message = 'Click to copy', tooltip_success = 'Done')
```


---  


To copy the code, click the button in the upper right corner of the code-chunks.

# Getting started

## clean up

```{r, results='hide'}
rm(list=ls())
gc()
```

<br>

## general custom functions

- `fpackage.check`: Check if packages are installed (and install if not) in R
- `fsave`: Function to save data with time stamp in correct directory
- `fload`: Function to load R-objects under new names
- `ftable`: html tables using `knitr`

```{r, eval=FALSE}
fpackage.check <- function(packages) {
    lapply(packages, FUN = function(x) {
        if (!require(x, character.only = TRUE)) {
            install.packages(x, dependencies = TRUE)
            library(x, character.only = TRUE)
        }
    })
}

fsave <- function(x, file, location = "./data/processed/", ...) {
    if (!dir.exists(location))
        dir.create(location)
    datename <- substr(gsub("[:-]", "", Sys.time()), 1, 8)
    totalname <- paste(location, datename, file, sep = "")
    print(paste("SAVED: ", totalname, sep = ""))
    save(x, file = totalname)
}


fload  <- function(fileName){
  load(fileName)
  get(ls()[ls() != "fileName"])
}

ftable <- function(x, caption=NULL) {
  knitr::kable(x, digits=2, "html", caption=caption) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) %>%
    kableExtra::scroll_box(height="300px")
}
```

<br>

## necessary packages

- `tidyverse`: data wrangling
- `reshape2`: reshaping data
- `mlogit`: construct dataframe for multinomial logit model
- `haven`: read and write various data formats
- `sjlabelled`: work with labelled (SPSS) data

```{r, eval=FALSE}
packages = c("tidyverse", "mlogit", "haven", "sjlabelled", "reshape2")
fpackage.check(packages)
rm(packages)
```

<br>


---

# I&O Panel


## load in data

Load in waves 1 and 2 of the I&O panel. Unlabel the data.

```{r}
haven::read_sav("./rawdata/DRADTRIAL21_totaal.sav") %>%
  sjlabelled::unlabel(.,verbose=FALSE) -> df1

haven::read_sav("./rawdata/DRADTRIAL22_totaal.sav") %>%
  sjlabelled::unlabel(.,verbose=FALSE) -> df2
```

<br> 

## data wrangling


```{r, eval=F}
#subset wave 1 respondents that filled out wave 2
df1. <- df1[which(df1$SAMPLE_ID %in% df2$SAMPLE_ID), ]

# interaction variables
# current involvement
#df2$V5
df2$activeW2 <- ifelse(df2$V5 == 1, "no", "yes")
prop.table(table(df2$activeW2, useNA = "always")) #64 percent currently active, at w2

#number of sports
#table(df2$V5)
#psych::describe(c(rep(1,1270), rep(2,573), rep(3,224)))

#self report sports frequency
sport1 <- ifelse(df2$V6a==1, 7, ifelse(df2$V6a==2, 4, ifelse(df2$V6a==3, 1.5, ifelse(df2$V6a==4, 0.5, NA))))
sport2 <- ifelse(df2$V6b==1, 7, ifelse(df2$V6b==2, 4, ifelse(df2$V6b==3, 1.5, ifelse(df2$V6b==4, 0.5, NA))))
sport3 <- ifelse(df2$V6c==1, 7, ifelse(df2$V6c==2, 4, ifelse(df2$V6c==3, 1.5, ifelse(df2$V6c==4, 0.5, NA))))

df2$sportsfreq <- NA
df2$sportsfreq[which(df2$activeW2=="yes")] <- rowSums(cbind(sport1,sport2,sport3)[which(df2$activeW2=="yes"),], na.rm=TRUE)

#table(df2$sportsfreq)
#cap at 14, only 1 higher.
df2$sportsfreq <- ifelse(df2$sportsfreq>14, 14, df2$sportsfreq)
#psych::describe(df2$sportsfreq)

#subset dce data and relevant covariates
#names(df2)

df <- df2[, c(
  which(grepl("Keuze", names(df2))), #dce data
  which(grepl("activ", names(df2))), #activity variables
  289, 299)#gender, sports frequency weekly
  ]

#gender
df$gender <- ifelse(df$GESLACHT2==1,"man",ifelse(df$GESLACHT2==2,"woman", "other"))

#attach id
df$id <- 1:nrow(df)
#fix(df)

# to long format

# each list element contains the choices for each set. thus presatielist[[2]][3] is the
# 'presatie'-attribute of person 3, in choice set 2

prestatielist <- list()
prestatielist[[1]] <- c("LoopKeuzesets_1_LoopAlternatieven_1_Prestaties", "LoopKeuzesets_1_LoopAlternatieven_2_Prestaties", "LoopKeuzesets_1_LoopAlternatieven_3_Prestaties")
prestatielist[[2]] <- c("LoopKeuzesets_2_LoopAlternatieven_1_Prestaties", "LoopKeuzesets_2_LoopAlternatieven_2_Prestaties", "LoopKeuzesets_2_LoopAlternatieven_3_Prestaties")
prestatielist[[3]] <- c("LoopKeuzesets_3_LoopAlternatieven_1_Prestaties", "LoopKeuzesets_3_LoopAlternatieven_2_Prestaties", "LoopKeuzesets_3_LoopAlternatieven_3_Prestaties")

kennislist <- list()
kennislist[[1]] <- c("LoopKeuzesets_1_LoopAlternatieven_1_Kennis", "LoopKeuzesets_1_LoopAlternatieven_2_Kennis", "LoopKeuzesets_1_LoopAlternatieven_3_Kennis")
kennislist[[2]] <- c("LoopKeuzesets_2_LoopAlternatieven_1_Kennis", "LoopKeuzesets_2_LoopAlternatieven_2_Kennis", "LoopKeuzesets_2_LoopAlternatieven_3_Kennis")
kennislist[[3]] <- c("LoopKeuzesets_3_LoopAlternatieven_1_Kennis", "LoopKeuzesets_3_LoopAlternatieven_2_Kennis", "LoopKeuzesets_3_LoopAlternatieven_3_Kennis")

gezelliglist <- list()
gezelliglist[[1]] <- c("LoopKeuzesets_1_LoopAlternatieven_1_Gezellig", "LoopKeuzesets_1_LoopAlternatieven_2_Gezellig", "LoopKeuzesets_1_LoopAlternatieven_3_Gezellig")
gezelliglist[[2]] <- c("LoopKeuzesets_2_LoopAlternatieven_1_Gezellig", "LoopKeuzesets_2_LoopAlternatieven_2_Gezellig", "LoopKeuzesets_2_LoopAlternatieven_3_Gezellig")
gezelliglist[[3]] <- c("LoopKeuzesets_3_LoopAlternatieven_1_Gezellig", "LoopKeuzesets_3_LoopAlternatieven_2_Gezellig", "LoopKeuzesets_3_LoopAlternatieven_3_Gezellig")

esteemlist <- list()
esteemlist[[1]] <- c("LoopKeuzesets_1_LoopAlternatieven_1_Aanmoediging", "LoopKeuzesets_1_LoopAlternatieven_2_Aanmoediging", "LoopKeuzesets_1_LoopAlternatieven_3_Aanmoediging")
esteemlist[[2]] <- c("LoopKeuzesets_2_LoopAlternatieven_1_Aanmoediging", "LoopKeuzesets_2_LoopAlternatieven_2_Aanmoediging", "LoopKeuzesets_2_LoopAlternatieven_3_Aanmoediging")
esteemlist[[3]] <- c("LoopKeuzesets_3_LoopAlternatieven_1_Aanmoediging", "LoopKeuzesets_3_LoopAlternatieven_2_Aanmoediging", "LoopKeuzesets_3_LoopAlternatieven_3_Aanmoediging")

chosen <- c("V84_LoopKeuzesets_1", "V85_LoopKeuzesets_2", "V86_LoopKeuzesets_3")

for (set in 1:3) {

  # to long format
    
  for (choice in 1:3) {
    
        data <- as.data.frame(df)
        data$set <- set
        data$options <- choice 
        data$comparison <- data[, names(data) == prestatielist[[set]][choice]]
        data$knowledge <- data[, names(data) == kennislist[[set]][choice]]
        data$companionship <- data[, names(data) == gezelliglist[[set]][choice]]
        data$encouragement <- data[, names(data) == esteemlist[[set]][choice]]
        data$chosen <- data[, names(data) == chosen[set]]
        
        data <- data[, names(data) %in% c("id", "gender", "activeW2", "sportsfreq", "set", "options", "comparison", "knowledge", "companionship",
            "encouragement", "chosen")]
        if (set == 1 & choice == 1) {
            df_long <- data
        } else {
            df_long <- rbind(df_long, data)
        }
    }
}

# order
df_long <- df_long[order(df_long$id, df_long$set, df_long$options), ]

# define the choice
df_long$choice <- (df_long$chosen == c(1, 2, 3)[df_long$options])

#recode number into answer
df_long$comparison <- ifelse(df_long$comparison == 1, "really likes to compare sports performances",
                             ifelse(df_long$comparison == 2, "somewhat likes to compare sports performances",
                             ifelse(df_long$comparison == 3, "does not like to compare sports performances", NA)))

df_long$knowledge <- ifelse(df_long$knowledge == 1, "knows more than you about effective training and the right technique",
                             ifelse(df_long$knowledge == 2, "knows as much as you about effective training and the right technique",
                             ifelse(df_long$knowledge == 3, "knows less than you about effective training and the right technique", NA))) 

df_long$companionship <- ifelse(df_long$companionship == 1, "exercises to socially engage",
                             ifelse(df_long$companionship == 2, "wants a combination of social interaction and purposeful training",
                             ifelse(df_long$companionship == 3, "exercises purposefully and seriously", NA)))

df_long$encouragement <- ifelse(df_long$encouragement == 1, "always encourages you",
                             ifelse(df_long$encouragement == 2, "sometimes encourages you",
                             ifelse(df_long$encouragement == 3, "never encourages you", NA)))

row.names(df_long) <- 1:nrow(df_long)

#set NAs on frequency to 0
#df_long$sportsfreq[is.na(df_long$sportsfreq)] <- 0
#OR: leave these out in the analyses; to distinguish among those who are currently active, those who are relatively (in)active

#remove "chosen" and "options" variable
#names(df_long)
data <- df_long[,-c(6,11)]
#recode Y
data$choice <- ifelse(data$choice==TRUE,1,0)

#convert features to factor level
#names(data)
cols_to_convert <- c("comparison", "knowledge", "companionship", "encouragement","activeW2","gender", "set")
data[cols_to_convert] <- lapply(data[cols_to_convert], as.factor)

#re-order
data$comparison <- factor(data$comparison, levels = c("really likes to compare sports performances","somewhat likes to compare sports performances","does not like to compare sports performances"))

data$knowledge <- factor(data$knowledge, levels = c("knows more than you about effective training and the right technique","knows as much as you about effective training and the right technique","knows less than you about effective training and the right technique"))

data$companionship <- factor(data$companionship, levels = c("exercises to socially engage","wants a combination of social interaction and purposeful training","exercises purposefully and seriously"))

data$encouragement <- factor(data$encouragement, levels = c("always encourages you", "sometimes encourages you", "never encourages you"))

#save
fsave(data, "conjoint.Rda")

```

<!---

## make ready for mlogit

```{r, eval=F}
# first we need an id_alt (identification of alternatives), thus specific combi of facets
{
    df_long$id_alt <- as.numeric(as.factor(trimws(df_long$comparison))) * 1000 + as.numeric(as.factor(trimws(df_long$knowledge))) *
        100 + as.numeric(as.factor(trimws(df_long$companionship))) * 10 + as.numeric(as.factor(trimws(df_long$encouragement)))

}

# we also need an id for each specific choice set, thus combi of respnr and set
df_long$id_choice <- df_long$id * 10 + df_long$set

length(unique(df_long$id))
length(unique(df_long$id_choice))
sum(df_long$choice)#no missings on choice. !be aware these need to be deleted for mlogit. 

# need to delete id_choice where no choice is made

# do we have duplicates?
df_long %>%
    select(c("id_choice", "id_alt")) -> df_sel
dups <- duplicated(df_sel)
sum(dups)

#head(df_long)

# and with no duplicates and no choice sets without choices, this should work 
df_ml <- mlogit.data(df_long, choice = "choice", id.var = "id", chid.var = "id_choice", alt.var = "id_alt", shape = "long")


```


--->

<br>

## save data object
```{r, eval=F}
fsave(df_ml, "io_ml.RData")
```


