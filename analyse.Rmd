---
title: "Analyses"
bibliography: references.bib
date: "Last compiled on `r format(Sys.time(), '%B, %Y')`"
output: 
  html_document:
    css: tweaks.css
    toc:  true
    toc_float: true
    number_sections: true
    toc_depth: 2
    code_folding: show
    code_download: yes
---

```{r, globalsettings, echo=FALSE, warning=FALSE, results='hide', message=FALSE}
library(knitr)
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
opts_chunk$set(tidy.opts=list(width.cutoff=100),tidy=TRUE, warning = FALSE, message = FALSE,comment = "#>", cache=TRUE, class.source=c("test"), class.output=c("test3"))
options(width = 100)
rgl::setupKnitr()

colorize <- function(x, color) {sprintf("<span style='color: %s;'>%s</span>", color, x) }
```


```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy(position = c('top', 'right'))
#klippy::klippy(color = 'darkred')
#klippy::klippy(tooltip_message = 'Click to copy', tooltip_success = 'Done')
```


---  


To copy the code, click the button in the upper right corner of the code-chunks.

# Getting started

## clean up

```{r, results='hide'}
rm(list=ls())
gc()
```

<br>

## general custom functions

- `fpackage.check`: Check if packages are installed (and install if not) in R
- `fsave`: Function to save data with time stamp in /correct directory
- `fload`: Function to load R-objects under new names
- `ftable`: html tables using `knitr`
- `ftheme`: pretty `ggplot2` theme

```{r}
fpackage.check <- function(packages) {
    lapply(packages, FUN = function(x) {
        if (!require(x, character.only = TRUE)) {
            install.packages(x, dependencies = TRUE)
            library(x, character.only = TRUE)
        }
    })
}

fsave <- function(x, file, location = "./data/processed/", ...) {
    if (!dir.exists(location))
        dir.create(location)
    datename <- substr(gsub("[:-]", "", Sys.time()), 1, 8)
    totalname <- paste(location, datename, file, sep = "")
    print(paste("SAVED: ", totalname, sep = ""))
    save(x, file = totalname)
}


fload  <- function(fileName){
  load(fileName)
  get(ls()[ls() != "fileName"])
}


ftable <- function(x, caption=NULL) {
  knitr::kable(x, digits=2, "html", caption=caption) %>%
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover")) %>%
    kableExtra::scroll_box(height="300px")
}

#extrafont::font_import(paths = c("C:/Users/u244147/Downloads/Jost/", prompt = FALSE))
ftheme <- function() {
  
  #download font at https://fonts.google.com/specimen/Jost/
  theme_minimal(base_family = "Jost") +
    theme(panel.grid.minor = element_blank(),
          plot.title = element_text(family = "Jost", face = "bold"),
          axis.title = element_text(family = "Jost Medium"),
          axis.title.x = element_text(hjust = 0),
          axis.title.y = element_text(hjust = 1),
          strip.text = element_text(family = "Jost", face = "bold",
                                    size = rel(0.75), hjust = 0),
          strip.background = element_rect(fill = "grey90", color = NA),
          legend.position = "bottom")
}

```


<br>

## necessary packages

- `tidyverse`: data wrangling
- `cregg`: calculate and visualize marginal means and average marginal component effects

```{r, eval=FALSE}
packages = c("tidyverse", "cregg")
fpackage.check(packages)
```
```{r fonts, echo=FALSE, warning=FALSE, results='hide'}
# import font JOST
#extrafont::font_import(pattern = "Jost")
extrafont::loadfonts(device="win")

# Set default theme and font stuff
theme_set(ftheme())
update_geom_defaults("text", list(family = "Jost", fontface = "plain"))
update_geom_defaults("label", list(family = "Jost", fontface = "plain"))
```


<br>

# import

Load in data-set, created [here](https://robfranken.github.io/DCE_sports/prep.html).

You may also obtain it by downloading: `r xfun::embed_file("./data shared/conjoint.Rda")`.


```{r}
today <- gsub("-", "", Sys.Date())
data <- fload(paste0("./data/processed/", today, "conjoint.Rda"))
```

<br>


# MMs

I report (unadjusted) marginal means (MMs) to provide a *descriptive* summary of respondent preferences, reflecting the percentage of, here sports partners, with a particular attribute-level, that is chosen by respondents.

In our choice design, respondents were presented with 3 alternatives in each choice-set, resulting in MMs that average at about 0.33. Values above/below 0.33 indicate attribute-levels that enhance/decrease the attractiveness of alternatives. 

```{r, fig.width=10, warning=FALSE, message=FALSE} 
f1 <- choice ~ comparison + knowledge + companionship + encouragement
mm <- cregg::mm(data, f1, id = ~id)
ftable(mm)

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
plot(mm, vline = 1/3) + ftheme() + scale_colour_manual(values=cbPalette)
```

<br>

# AMCEs

Average marginal component effects [@hainmueller2014; @leeper2020]

```{r, fig.width=10, warning=FALSE, message=FALSE} 
amce <- cregg::cj(data, f1, id = ~id)
ftable(amce)
plot(amce) + ftheme() + scale_colour_manual(values=cbPalette)
```


## Reference category diagnostics for AMCEs

<style>
.scrollbox {
  max-height: 400px; /* Specify the maximum height of the scrollbox */
  overflow-y: scroll; /* Enable vertical scrolling */
  border: 1px solid #ccc; /* Add a border for visual distinction */
}
</style>

<div class="scrollbox">

```{r, fig.width=12, fig.height=12, warning=FALSE, message=FALSE, class.source='fold-hide'} 
amce_diagnostic1 <- cregg::amce_by_reference(data, choice ~ comparison, variable = ~comparison, id = ~id)
amce_diagnostic2 <- cregg::amce_by_reference(data, choice ~ knowledge, variable = ~knowledge, id = ~id)
amce_diagnostic3 <- cregg::amce_by_reference(data, choice ~ companionship, variable = ~companionship, id = ~id)
amce_diagnostic4 <- cregg::amce_by_reference(data, choice ~ encouragement, variable = ~encouragement, id = ~id)

plot1 <- plot(amce_diagnostic1, group = "REFERENCE", legend_title = "Ref. cat.") + ftheme() + scale_colour_manual(values=cbPalette)
plot2 <- plot(amce_diagnostic2, group = "REFERENCE", legend_title = "Ref. cat.") + ftheme() + scale_colour_manual(values=cbPalette)
plot3 <- plot(amce_diagnostic3, group = "REFERENCE", legend_title = "Ref. cat.") + ftheme() + scale_colour_manual(values=cbPalette)
plot4 <- plot(amce_diagnostic4, group = "REFERENCE", legend_title = "Ref. cat.") + ftheme() + scale_colour_manual(values=cbPalette)

multiplot <- gridExtra::grid.arrange(plot1,plot2,plot3,plot4,ncol=1)
```

</div>

<br>

# Subgroup analysis

## Subgroup marginal means {.tabset .tabset-fade} 

Estimate conditional marginal means and differences between conditional marginal means to describe differences in preference level between subgroups. To formally test for groups differences in preferences toward particular features, I use omnibus nested model comparisons. 

### Male vs female

```{r, fig.width=10, warning=FALSE, message=FALSE} 
data$Sex <- NA_real_
data$Sex[data$gender == "man"] <- 1L
data$Sex[data$gender == "woman"] <- 2L
data$Sex <- factor(data$Sex, 1:2, c("Male", "Female"))

#conditional MM
mm <- cregg::cj(na.omit(data), f1, id = ~id, estimate = "mm", by = ~Sex)
mm <- mm %>% arrange(level, feature)

#difference between subgroups
diff_mm <- cregg::cj(na.omit(data), f1, id = ~id, estimate = "mm_diff", by = ~Sex)

#combine plots
p <- plot(rbind(mm, diff_mm)) + ggplot2::facet_wrap(~ BY, ncol = 3L) + ftheme() + scale_colour_manual(values=cbPalette)

#i want different vlines (0.3 for mm; 0 for difference)
p$layers[[1]] <- NULL #first remove existing layer

vlines <- data.frame(
  BY = c("Male", "Female", "Female - Male"), 
  vline_x = c(1/3, 1/3, 0) 
)
vlines$BY <- factor(vlines$BY, levels = c("Female", "Male", "Female - Male"))

p <- p + geom_vline(data = vlines, aes(xintercept = vline_x), color = "grey") 
p

#test of preference heterogeneity (nested model comparison test)
cregg::cj_anova(na.omit(data), choice ~ comparison, by = ~Sex)
cregg::cj_anova(na.omit(data), choice ~ knowledge, by = ~Sex)
cregg::cj_anova(na.omit(data), choice ~ companionship, by = ~Sex)
cregg::cj_anova(na.omit(data), choice ~ encouragement, by = ~Sex)
```

### active vs non-active

```{r, fig.width=10, warning=FALSE, message=FALSE} 
data$Active <- NA_real_
data$Active[data$activeW2 == "yes"] <- 2L
data$Active[data$activeW2 == "no"] <- 1L
data$Active <- factor(data$Active, 1:2, c("Not active", "Active"))

#conditional MM
mm <- cregg::cj(data, f1, id = ~id, estimate = "mm", by = ~Active)
mm <- mm %>% arrange(level, feature)

#difference between subgroups
diff_mm <- cregg::cj(data, f1, id = ~id, estimate = "mm_diff", by = ~Active)

#combine plots
p <- plot(rbind(mm, diff_mm)) + ggplot2::facet_wrap(~ BY, ncol = 3L) + ftheme() + scale_colour_manual(values=cbPalette)

#i want different vlines (0.3 for mm; 0 for difference)
p$layers[[1]] <- NULL #first remove existing layer

vlines <- data.frame(
  BY = c("Not active", "Active", "Active - Not active"), 
  vline_x = c(1/3, 1/3, 0) 
)
vlines$BY <- factor(vlines$BY, levels = c("Active", "Not active", "Active - Not active"))

p <- p + geom_vline(data = vlines, aes(xintercept = vline_x), color = "grey") 
p

#test of preference heterogeneity (nested model comparison test)
cregg::cj_anova(data, choice ~ comparison, by = ~Active)
cregg::cj_anova(data, choice ~ knowledge, by = ~Active)
cregg::cj_anova(data, choice ~ companionship, by = ~Active)
cregg::cj_anova(data, choice ~ encouragement, by = ~Active)
```



### High vs low frequency

```{r, fig.width=10, warning=FALSE, message=FALSE} 
#sports_frequency <- ifelse(is.na(data$sportsfreq), 0, as.numeric(data$sportsfreq))
#hist(sports_frequency)
#ftable(psych::describe(sports_frequency))

#here, focus only on those currently active..
data$Frequency <- NA_real_
data$Frequency[data$sportsfreq < 3] <- 1L
data$Frequency[data$sportsfreq >= 3] <- 2L
data$Frequency <- factor(data$Frequency, 1:2, c("Low frequency", "High frequency"))

#conditional MM
mm <- cregg::cj(data, f1, id = ~id, estimate = "mm", by = ~Frequency)
mm <- mm %>% arrange(level, feature)

#difference between subgroups
diff_mm <- cregg::cj(data, f1, id = ~id, estimate = "mm_diff", by = ~Frequency)

#combine plots
p <- plot(rbind(mm, diff_mm)) + ggplot2::facet_wrap(~ BY, ncol = 3L) + ftheme() + scale_colour_manual(values=cbPalette)

#i want different vlines (0.3 for mm; 0 for difference)
p$layers[[1]] <- NULL #first remove existing layer

vlines <- data.frame(
  BY = c("High frequency","Low frequency", "High frequency - Low frequency"), 
  vline_x = c(1/3, 1/3, 0) 
)
vlines$BY <- factor(vlines$BY, levels = c("High frequency","Low frequency", "High frequency - Low frequency"))

p <- p + geom_vline(data = vlines, aes(xintercept = vline_x), color = "grey") 
p

#test of preference heterogeneity (nested model comparison test)

#set missings on sex to "Male" (or female; so they are not dropped...)
data$Sex[is.na(data$Sex)] <- "Male"

cregg::cj_anova(na.omit(data), choice ~ comparison, by = ~Frequency)
cregg::cj_anova(na.omit(data), choice ~ knowledge, by = ~Frequency)
cregg::cj_anova(na.omit(data), choice ~ companionship, by = ~Frequency)
cregg::cj_anova(na.omit(data), choice ~ encouragement, by = ~Frequency)
```

## {.unlisted .unnumbered}

<br>

# Diagnostics

## Frequencies

Of conjoint features (to ensure equal display frequency):

```{r, fig.width=12, fig.height=12, warning=FALSE, message=FALSE}
plot(cregg::cj_freqs(data, choice ~ comparison + knowledge + companionship + encouragement + Sex + Active + Frequency, id = ~id)) + ftheme() + scale_colour_manual(values=cbPalette)
```

---

# References

